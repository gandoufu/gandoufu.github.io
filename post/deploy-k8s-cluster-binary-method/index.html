<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K8S 集群部署（二进制方式） - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="jiaqiang" /><meta name="description" content="一、环境准备 1. 软件环境 软件 版本信息 操作系统 CentOS 7.6.1810 Docker 19.03.13 Kubernetes 1.19 etcd v3.14.13 flannel v0.13.0 2. 虚拟机信息 主机名 IP 需安装组件 master 172.16.207.128 kube-apiserver，kube-co" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.80.0 with theme even" />


<link rel="canonical" href="https://gandoufu.github.io/post/deploy-k8s-cluster-binary-method/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.2e81bbed97b8b282c1aeb57488cc71c8d8c8ec559f3931531bd396bf31e0d4dd.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="K8S 集群部署（二进制方式）" />
<meta property="og:description" content="一、环境准备 1. 软件环境 软件 版本信息 操作系统 CentOS 7.6.1810 Docker 19.03.13 Kubernetes 1.19 etcd v3.14.13 flannel v0.13.0 2. 虚拟机信息 主机名 IP 需安装组件 master 172.16.207.128 kube-apiserver，kube-co" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gandoufu.github.io/post/deploy-k8s-cluster-binary-method/" />
<meta property="article:published_time" content="2020-10-26T15:55:05+08:00" />
<meta property="article:modified_time" content="2020-10-26T15:55:05+08:00" />
<meta itemprop="name" content="K8S 集群部署（二进制方式）">
<meta itemprop="description" content="一、环境准备 1. 软件环境 软件 版本信息 操作系统 CentOS 7.6.1810 Docker 19.03.13 Kubernetes 1.19 etcd v3.14.13 flannel v0.13.0 2. 虚拟机信息 主机名 IP 需安装组件 master 172.16.207.128 kube-apiserver，kube-co">
<meta itemprop="datePublished" content="2020-10-26T15:55:05+08:00" />
<meta itemprop="dateModified" content="2020-10-26T15:55:05+08:00" />
<meta itemprop="wordCount" content="5498">



<meta itemprop="keywords" content="k8s,etcd," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8S 集群部署（二进制方式）"/>
<meta name="twitter:description" content="一、环境准备 1. 软件环境 软件 版本信息 操作系统 CentOS 7.6.1810 Docker 19.03.13 Kubernetes 1.19 etcd v3.14.13 flannel v0.13.0 2. 虚拟机信息 主机名 IP 需安装组件 master 172.16.207.128 kube-apiserver，kube-co"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">jap</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">文章</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">jap</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K8S 集群部署（二进制方式）</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-10-26 </span>
        <div class="post-category">
            <a href="/categories/kubernetes/"> Kubernetes </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一环境准备">一、环境准备</a></li>
        <li><a href="#二部署-etcd-集群">二、部署 ETCD 集群</a></li>
        <li><a href="#三在-node-上部署docker">三、在 Node 上部署Docker</a></li>
        <li><a href="#四部署-flannel-网络">四、部署 Flannel 网络</a></li>
        <li><a href="#五在-master-节点部署组件">五、在 master 节点部署组件</a></li>
        <li><a href="#六在-node-节点部署组件">六、在 Node 节点部署组件</a></li>
        <li><a href="#七运行一个测试示例">七、运行一个测试示例</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="一环境准备">一、环境准备</h2>
<p><strong>1. 软件环境</strong></p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统</td>
<td>CentOS 7.6.1810</td>
</tr>
<tr>
<td>Docker</td>
<td>19.03.13</td>
</tr>
<tr>
<td>Kubernetes</td>
<td><a href="https://dl.k8s.io/v1.19.3/kubernetes-server-linux-amd64.tar.gz">1.19</a></td>
</tr>
<tr>
<td>etcd</td>
<td><a href="https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz">v3.14.13</a></td>
</tr>
<tr>
<td>flannel</td>
<td><a href="https://github.com/coreos/flannel/releases/download/v0.13.0/flannel-v0.13.0-linux-amd64.tar.gz">v0.13.0</a></td>
</tr>
</tbody>
</table>
<p><strong>2. 虚拟机信息</strong></p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>需安装组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>172.16.207.128</td>
<td>kube-apiserver，kube-controller-manager，kube-scheduler，etcd</td>
</tr>
<tr>
<td>node1</td>
<td>172.16.207.129</td>
<td>kubelet，kube-proxy，docker，flannel，etcd</td>
</tr>
<tr>
<td>node2</td>
<td>172.16.207.130</td>
<td>kubelet，kube-proxy，docker，flannel，etcd</td>
</tr>
</tbody>
</table>
<p><strong>3. 操作系统初始化</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># 关闭防火墙</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">firewalld</span>
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">firewalld</span>

<span class="c"># 关闭 selinux</span>
<span class="n">setenforce</span> <span class="n">0</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s/enforcing/disabled/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">selinux</span><span class="p">/</span><span class="n">config</span>

<span class="c"># 关闭swap</span>
<span class="n">swapoff</span> <span class="n">-a</span>
<span class="n">sed</span> <span class="n">-ri</span> <span class="s1">&#39;s/.swap./#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>

<span class="c"># 设置主机名</span>
<span class="n">hostnamectl</span> <span class="nb">set-hostname</span> <span class="n">master</span>

<span class="c"># 修改hosts文件</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">hosts</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span> <span class="n">master</span>
<span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span> <span class="n">node1</span>
<span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span> <span class="n">node2</span>
<span class="n">EOF</span>

<span class="c"># 将桥接的IPv4流量传递到iptables的链</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">EOF</span>

<span class="c"># 使修改生效</span>
<span class="n">sysctl</span> <span class="p">-</span><span class="n">-system</span>

<span class="c"># 时间同步</span>
<span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ntpdate</span>
<span class="n">ntpdate</span> <span class="n">ntp1</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>
</code></pre></td></tr></table>
</div>
</div><p>以上操作在 master 上执行，node1、node2 做相同的修改操作（注意hostname）。</p>
<p><strong>4. ssh 免登录设置</strong></p>
<p>进行此操作，方便后续从 master 拷贝文件到 node，不用重复输入密码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># 在 master 上执行命令</span>
<span class="c"># 一路回车即可</span>
<span class="n">ssh-keygen</span>
<span class="n">ssh-copy-id</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span>
<span class="n">ssh-copy-id</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="二部署-etcd-集群">二、部署 ETCD 集群</h2>
<p><strong>1. 下载 cfssl 工具</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># ll</span>
<span class="n">总用量</span> <span class="n">4</span>
<span class="n">-rw</span><span class="p">-------.</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">1200</span> <span class="n">10月</span> <span class="n">16</span> <span class="n">09</span><span class="err">:</span><span class="n">00</span> <span class="n">anaconda-ks</span><span class="p">.</span><span class="n">cfg</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># curl -o cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span>
  <span class="p">%</span> <span class="n">Total</span>    <span class="p">%</span> <span class="n">Received</span> <span class="p">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
<span class="n">100</span>  <span class="n">9</span><span class="p">.</span><span class="n">8M</span>  <span class="n">100</span>  <span class="n">9</span><span class="p">.</span><span class="n">8M</span>    <span class="n">0</span>     <span class="n">0</span>   <span class="n">153k</span>      <span class="n">0</span>  <span class="n">0</span><span class="err">:</span><span class="n">01</span><span class="err">:</span><span class="n">06</span>  <span class="n">0</span><span class="err">:</span><span class="n">01</span><span class="err">:</span><span class="n">06</span> <span class="p">--</span><span class="err">:</span><span class="p">--</span><span class="err">:</span><span class="p">--</span>  <span class="n">220k</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># curl -o cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span>
  <span class="p">%</span> <span class="n">Total</span>    <span class="p">%</span> <span class="n">Received</span> <span class="p">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
<span class="n">100</span> <span class="n">2224k</span>  <span class="n">100</span> <span class="n">2224k</span>    <span class="n">0</span>     <span class="n">0</span>   <span class="n">129k</span>      <span class="n">0</span>  <span class="n">0</span><span class="err">:</span><span class="n">00</span><span class="err">:</span><span class="n">17</span>  <span class="n">0</span><span class="err">:</span><span class="n">00</span><span class="err">:</span><span class="n">17</span> <span class="p">--</span><span class="err">:</span><span class="p">--</span><span class="err">:</span><span class="p">--</span>  <span class="n">202k</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># curl -o cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span>
  <span class="p">%</span> <span class="n">Total</span>    <span class="p">%</span> <span class="n">Received</span> <span class="p">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
<span class="n">100</span> <span class="n">6440k</span>  <span class="n">100</span> <span class="n">6440k</span>    <span class="n">0</span>     <span class="n">0</span>   <span class="n">212k</span>      <span class="n">0</span>  <span class="n">0</span><span class="err">:</span><span class="n">00</span><span class="err">:</span><span class="n">30</span>  <span class="n">0</span><span class="err">:</span><span class="n">00</span><span class="err">:</span><span class="n">30</span> <span class="p">--</span><span class="err">:</span><span class="p">--</span><span class="err">:</span><span class="p">--</span>  <span class="n">232k</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># chmod +x cfssl*</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mv cfssl* /usr/local/bin/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># ls -lh /usr/local/bin/ | grep cfssl</span>
<span class="n">-rwxr-xr-x</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">9</span><span class="p">.</span><span class="n">9M</span> <span class="n">10月</span> <span class="n">26</span> <span class="n">16</span><span class="err">:</span><span class="n">44</span> <span class="n">cfssl</span>
<span class="n">-rwxr-xr-x</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">6</span><span class="p">.</span><span class="n">3M</span> <span class="n">10月</span> <span class="n">26</span> <span class="n">16</span><span class="err">:</span><span class="n">46</span> <span class="n">cfssl-certinfo</span>
<span class="n">-rwxr-xr-x</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">2</span><span class="p">.</span><span class="n">2M</span> <span class="n">10月</span> <span class="n">26</span> <span class="n">16</span><span class="err">:</span><span class="n">45</span> <span class="n">cfssljson</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2. 生成证书</strong></p>
<p>可以使用脚本生成 etcd 使用的证书，修改脚本中的 IP 地址即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># gen_cert.sh</span>

cat &gt; ca-config.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">  &#34;signing&#34;: {
</span><span class="s">    &#34;default&#34;: {
</span><span class="s">      &#34;expiry&#34;: &#34;87600h&#34;
</span><span class="s">    },
</span><span class="s">    &#34;profiles&#34;: {
</span><span class="s">      &#34;etcd&#34;: {
</span><span class="s">         &#34;expiry&#34;: &#34;87600h&#34;,
</span><span class="s">         &#34;usages&#34;: [
</span><span class="s">            &#34;signing&#34;,
</span><span class="s">            &#34;key encipherment&#34;,
</span><span class="s">            &#34;server auth&#34;,
</span><span class="s">            &#34;client auth&#34;
</span><span class="s">        ]
</span><span class="s">      }
</span><span class="s">    }
</span><span class="s">  }
</span><span class="s">}
</span><span class="s">EOF</span>

cat &gt; ca-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">    &#34;CN&#34;:&#34;etcd CA&#34;,
</span><span class="s">    &#34;key&#34;:{
</span><span class="s">        &#34;algo&#34;:&#34;rsa&#34;,
</span><span class="s">        &#34;size&#34;:2048
</span><span class="s">    },
</span><span class="s">    &#34;names&#34;:[
</span><span class="s">        {
</span><span class="s">            &#34;C&#34;:&#34;CN&#34;,
</span><span class="s">            &#34;L&#34;:&#34;Beijing&#34;,
</span><span class="s">            &#34;ST&#34;:&#34;Beijing&#34;
</span><span class="s">        }
</span><span class="s">    ]
</span><span class="s">}
</span><span class="s">EOF</span>
cfssl gencert -initca ca-csr.json <span class="p">|</span> cfssljson -bare ca -
<span class="c1">#-----------------------</span>
cat &gt; server-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">    &#34;CN&#34;:&#34;etcd&#34;,
</span><span class="s">    &#34;hosts&#34;:[
</span><span class="s">        &#34;172.16.207.128&#34;,
</span><span class="s">        &#34;172.16.207.129&#34;,
</span><span class="s">        &#34;172.16.207.130&#34;,
</span><span class="s">        &#34;172.16.207.131&#34;
</span><span class="s">    ],
</span><span class="s">    &#34;key&#34;:{
</span><span class="s">        &#34;algo&#34;:&#34;rsa&#34;,
</span><span class="s">        &#34;size&#34;:2048
</span><span class="s">    },
</span><span class="s">    &#34;names&#34;:[
</span><span class="s">        {
</span><span class="s">            &#34;C&#34;:&#34;CN&#34;,
</span><span class="s">            &#34;L&#34;:&#34;Beijing&#34;,
</span><span class="s">            &#34;ST&#34;:&#34;Beijing&#34;
</span><span class="s">        }
</span><span class="s">    ]
</span><span class="s">}
</span><span class="s">EOF</span>
cfssl gencert -ca<span class="o">=</span>ca.pem -ca-key<span class="o">=</span>ca-key.pem -config<span class="o">=</span>ca-config.json -profile<span class="o">=</span>etcd server-csr.json <span class="p">|</span> cfssljson -bare server
</code></pre></td></tr></table>
</div>
</div><p>执行脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir -p /opt/etcd/{bin,cfg,ssl}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd /opt/etcd/ssl/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># vim gen_cert.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># sh gen_cert.sh</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">generating</span> <span class="n">a</span> <span class="n">new</span> <span class="n">CA</span> <span class="n">key</span> <span class="n">and</span> <span class="n">certificate</span> <span class="n">from</span> <span class="n">CSR</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">generate</span> <span class="n">received</span> <span class="n">request</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">received</span> <span class="n">CSR</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">generating</span> <span class="n">key</span><span class="err">:</span> <span class="n">rsa</span><span class="p">-</span><span class="n">2048</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">encoded</span> <span class="n">CSR</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">signed</span> <span class="n">certificate</span> <span class="n">with</span> <span class="n">serial</span> <span class="n">number</span> <span class="n">675033904732590831374734318307602699131099554295</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">generate</span> <span class="n">received</span> <span class="n">request</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">received</span> <span class="n">CSR</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">23</span> <span class="no">[INFO]</span> <span class="n">generating</span> <span class="n">key</span><span class="err">:</span> <span class="n">rsa</span><span class="p">-</span><span class="n">2048</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">24</span> <span class="no">[INFO]</span> <span class="n">encoded</span> <span class="n">CSR</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">24</span> <span class="no">[INFO]</span> <span class="n">signed</span> <span class="n">certificate</span> <span class="n">with</span> <span class="n">serial</span> <span class="n">number</span> <span class="n">407300634356389796425320963385412894041260983445</span>
<span class="n">2020</span><span class="p">/</span><span class="n">10</span><span class="p">/</span><span class="n">26</span> <span class="n">17</span><span class="err">:</span><span class="n">02</span><span class="err">:</span><span class="n">24</span> <span class="no">[WARNING]</span> <span class="n">This</span> <span class="n">certificate</span> <span class="n">lacks</span> <span class="n">a</span> <span class="s2">&#34;hosts&#34;</span> <span class="n">field</span><span class="p">.</span> <span class="n">This</span> <span class="n">makes</span> <span class="n">it</span> <span class="n">unsuitable</span> <span class="k">for</span>
<span class="n">websites</span><span class="p">.</span> <span class="k">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">see</span> <span class="n">the</span> <span class="n">Baseline</span> <span class="n">Requirements</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Issuance</span> <span class="n">and</span> <span class="n">Management</span>
<span class="n">of</span> <span class="n">Publicly-Trusted</span> <span class="n">Certificates</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">6</span><span class="p">,</span> <span class="n">from</span> <span class="n">the</span> <span class="n">CA</span><span class="p">/</span><span class="n">Browser</span> <span class="n">Forum</span> <span class="p">(</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">cabforum</span><span class="p">.</span><span class="n">org</span><span class="p">);</span>
<span class="n">specifically</span><span class="p">,</span> <span class="n">section</span> <span class="n">10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">3</span> <span class="p">(</span><span class="s2">&#34;Information Requirements&#34;</span><span class="p">).</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># ls *.pem</span>
<span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">ca</span><span class="p">.</span><span class="n">pem</span>  <span class="n">server-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">server</span><span class="p">.</span><span class="n">pem</span>
</code></pre></td></tr></table>
</div>
</div><p>将名称以<code>.pem</code>尾缀的证书拷贝到 node1 和 node2：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># scp *.pem node1:/opt/etcd/ssl/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># scp *.pem node2:/opt/etcd/ssl/</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3. 部署</strong></p>
<p>1）下载 etcd，解压并拷贝到其他 node</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># tar zxvf etcd-v3.4.13-linux-amd64.tar.gz </span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd etcd-v3.4.13-linux-amd64</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">13-linux-amd64</span><span class="p">]</span><span class="c"># cp etcd etcdctl /usr/local/bin/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">13-linux-amd64</span><span class="p">]</span><span class="c"># scp etcd etcdctl node1:/usr/local/bin/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">13-linux-amd64</span><span class="p">]</span><span class="c"># scp etcd etcdctl node2:/usr/local/bin/</span>
</code></pre></td></tr></table>
</div>
</div><p>2）创建 etcd 数据目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir -p /var/lib/etcd</span>
</code></pre></td></tr></table>
</div>
</div><p>node1、node2 也要创建</p>
<p>3）创建 etcd 配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd /opt/etcd/cfg/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># vim etcd.conf</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c">#</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># cat etcd.conf</span>
<span class="c">#[Member]</span>
<span class="n">ETCD_NAME</span><span class="p">=</span><span class="s2">&#34;infra1&#34;</span>
<span class="n">ETCD_DATA_DIR</span><span class="p">=</span><span class="s2">&#34;/var/lib/etcd/infra1.etcd&#34;</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="p">=</span><span class="s2">&#34;https://172.16.207.128:2380&#34;</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="p">=</span><span class="s2">&#34;https://172.16.207.128:2379,http://127.0.0.1:2379&#34;</span>

<span class="c">#[Clustering]</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="p">=</span><span class="s2">&#34;https://172.16.207.128:2380&#34;</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="p">=</span><span class="s2">&#34;https://172.16.207.128:2379,http://127.0.0.1:2379&#34;</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="p">=</span><span class="s2">&#34;infra1=https://172.16.207.128:2380,infra2=https://172.16.207.129:2380,infra3=https://172.16.207.130:2380&#34;</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="p">=</span><span class="s2">&#34;etcd-cluster&#34;</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="p">=</span><span class="s2">&#34;new&#34;</span>
<span class="n">ETCD_ENABLE_V2</span><span class="p">=</span><span class="s2">&#34;true&#34;</span>

<span class="c">#[Security]</span>
<span class="n">ETCD_CERT_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/server.pem&#34;</span>
<span class="n">ETCD_KEY_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/server-key.pem&#34;</span>
<span class="n">ETCD_TRUSTED_CA_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/ca.pem&#34;</span>
<span class="n">ETCD_CLIENT_CERT_AUTH</span><span class="p">=</span><span class="s2">&#34;true&#34;</span>
<span class="n">ETCD_PEER_CERT_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/server.pem&#34;</span>
<span class="n">ETCD_PEER_KEY_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/server-key.pem&#34;</span>
<span class="n">ETCD_PEER_TRUSTED_CA_FILE</span><span class="p">=</span><span class="s2">&#34;/opt/etcd/ssl/ca.pem&#34;</span>
<span class="n">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="p">=</span><span class="s2">&#34;true&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>4）etcd 启动文件（systemd管理）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># vim /usr/lib/systemd/system/etcd.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># cat /usr/lib/systemd/system/etcd.service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Etcd</span>
<span class="n">ServerAfter</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>
<span class="n">After</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span>
<span class="n">Wants</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">notify</span>
<span class="n">WorkingDirectory</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span>
<span class="n">EnvironmentFile</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="n">-c</span> <span class="s2">&#34;GOMAXPROCS=</span><span class="p">$(</span><span class="n">nproc</span><span class="p">)</span><span class="s2"> /usr/local/bin/etcd&#34;</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">LimitNOFILE</span><span class="p">=</span><span class="n">65536</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
</code></pre></td></tr></table>
</div>
</div><p>5）同步配置及启动文件到 node1、node2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># pwd</span>
<span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">cfg</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># scp etcd.conf node1:/opt/etcd/cfg/</span>
<span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># scp etcd.conf node2:/opt/etcd/cfg/</span>
<span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># scp /usr/lib/systemd/system/etcd.service node1:/usr/lib/systemd/system/</span>
<span class="n">etcd</span><span class="p">.</span><span class="n">service</span>                                                                                             <span class="n">100</span><span class="p">%</span>  <span class="n">383</span>   <span class="n">335</span><span class="p">.</span><span class="n">9KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">cfg</span><span class="p">]</span><span class="c"># scp /usr/lib/systemd/system/etcd.service node2:/usr/lib/systemd/system/</span>
<span class="n">etcd</span><span class="p">.</span><span class="n">service</span>                                                                                             <span class="n">100</span><span class="p">%</span>  <span class="n">383</span>   <span class="n">267</span><span class="p">.</span><span class="n">7KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
</code></pre></td></tr></table>
</div>
</div><p>***注意：***同步到node后，需修改配置文件中的 IP 和 ETCD_NAME</p>
<p>6）启动etcd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl enable etcd</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl start etcd</span>
</code></pre></td></tr></table>
</div>
</div><p>7）查看集群状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&#34;https://172.16.207.128:2379,https://172.16.207.129:2379,https://172.16.207.130:2379&#34; endpoint health</span>
<span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">2379</span> <span class="n">is</span> <span class="n">healthy</span><span class="err">:</span> <span class="n">successfully</span> <span class="n">committed</span> <span class="n">proposal</span><span class="err">:</span> <span class="n">took</span> <span class="p">=</span> <span class="n">15</span><span class="p">.</span><span class="n">663882ms</span>
<span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span><span class="err">:</span><span class="n">2379</span> <span class="n">is</span> <span class="n">healthy</span><span class="err">:</span> <span class="n">successfully</span> <span class="n">committed</span> <span class="n">proposal</span><span class="err">:</span> <span class="n">took</span> <span class="p">=</span> <span class="n">18</span><span class="p">.</span><span class="n">706924ms</span>
<span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span><span class="err">:</span><span class="n">2379</span> <span class="n">is</span> <span class="n">healthy</span><span class="err">:</span> <span class="n">successfully</span> <span class="n">committed</span> <span class="n">proposal</span><span class="err">:</span> <span class="n">took</span> <span class="p">=</span> <span class="n">18</span><span class="p">.</span><span class="n">657068ms</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># etcdctl put /testdir/testkey &#34;hello etcd&#34;</span>
<span class="n">OK</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># etcdctl get /testdir/testkey &#34;hello etcd&#34;</span>
<span class="p">/</span><span class="n">testdir</span><span class="p">/</span><span class="n">testkey</span>
<span class="n">hello</span> <span class="n">etcd</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># etcdctl del /testdir/testkey &#34;hello etcd&#34;</span>
<span class="n">1</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="三在-node-上部署docker">三、在 Node 上部署Docker</h2>
<p>使用 yum 安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># 安装必要的一些系统工具</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">yum-utils</span> <span class="n">device-mapper-persistent-data</span> <span class="n">lvm2</span>
<span class="c"># 添加软件源信息</span>
<span class="n">yum-config-manager</span> <span class="p">-</span><span class="n">-add-repo</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">centos</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span>
<span class="c"># 更新并安装 Docker-CE</span>
<span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
<span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">docker-ce</span>
<span class="c"># 启动docker</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">docker</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="四部署-flannel-网络">四、部署 Flannel 网络</h2>
<p>Falnnel 要用 etcd 存储自身一个子网信息，所以要保证能成功连接 Etcd，写入预定义子网段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># etcd 配置文件中增加对 v2 接口的支持</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># grep &#34;ETCD_ENABLE&#34; /opt/etcd/cfg/etcd.conf</span>
<span class="n">ETCD_ENABLE_V2</span><span class="p">=</span><span class="s2">&#34;true&#34;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># export ETCDCTL_API=2</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># cd /opt/etcd/ssl/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># /opt/etcd/bin/etcdctl --ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem --endpoints=&#34;https://172.16.207.128:2379,https://172.16.207.129:2379,https://172.16.207.130:2379&#34; set /coreos.com/network/config &#39;{&#34;Network&#34;: &#34;172.17.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;vxlan&#34;}}&#39;</span>
<span class="p">{</span><span class="s2">&#34;Network&#34;</span><span class="err">:</span> <span class="s2">&#34;172.17.0.0/16&#34;</span><span class="p">,</span> <span class="s2">&#34;Backend&#34;</span><span class="err">:</span> <span class="p">{</span><span class="s2">&#34;Type&#34;</span><span class="err">:</span> <span class="s2">&#34;vxlan&#34;</span><span class="p">}}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># /opt/etcd/bin/etcdctl --ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem --endpoints=&#34;https://172.16.207.128:2379,https://172.16.207.129:2379,https://172.16.207.130:2379&#34; get /coreos.com/network/config</span>
<span class="p">{</span><span class="s2">&#34;Network&#34;</span><span class="err">:</span> <span class="s2">&#34;172.17.0.0/16&#34;</span><span class="p">,</span> <span class="s2">&#34;Backend&#34;</span><span class="err">:</span> <span class="p">{</span><span class="s2">&#34;Type&#34;</span><span class="err">:</span> <span class="s2">&#34;vxlan&#34;</span><span class="p">}}</span>
</code></pre></td></tr></table>
</div>
</div><p>**注意：**由于部署时使用的是 etcd 和 flannel 的最新版本，存在兼容问题，需做如下操作：</p>
<ul>
<li>修改 etcd 的配置文件，增加对v2接口的支持选项 ETCD_ENABLE_V2=&ldquo;true&rdquo;（重启etcd服务）</li>
<li>在终端执行命令前，指定使用 v2 接口</li>
</ul>
<p><strong>以下部署步骤在规划的每个 node 节点操作</strong></p>
<ol>
<li>
<p>解压二进制包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># tar zxvf flannel-v0.13.0-linux-amd64.tar.gz</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># mkdir /opt/kubernetes/{bin,cfg,ssl,logs} -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># mv flanneld mk-docker-opts.sh /opt/kubernetes/bin/</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置 flannel</p>
<p>执行脚本 flannel.sh 完成配置操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># mkdir flannel</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># cd flannel</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># vim flannel.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># cat flannel.sh</span>
<span class="c">#!/bin/bash</span>
   
<span class="n">ETCD_ENDPOINTS</span><span class="p">=${</span><span class="n">1</span><span class="err">:</span><span class="p">-</span><span class="s2">&#34;http://127.0.0.1:2379&#34;</span><span class="p">}</span>
   
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">flanneld</span>
<span class="n">FLANNEL_OPTIONS</span><span class="p">=</span><span class="s2">&#34;--etcd-endpoints=${ETCD_ENDPOINTS} \
</span><span class="s2">-etcd-cafile=/opt/etcd/ssl/ca.pem \
</span><span class="s2">-etcd-certfile=/opt/etcd/ssl/server.pem \
</span><span class="s2">-etcd-keyfile=/opt/etcd/ssl/server-key.pem&#34;</span>
<span class="n">EOF</span>
   
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">flanneld</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Flanneld</span> <span class="n">overlay</span> <span class="n">address</span> <span class="n">etcd</span> <span class="n">agent</span>
<span class="n">After</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span> <span class="n">network</span><span class="p">.</span><span class="n">target</span>
<span class="n">Before</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>
   
<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">notify</span>
<span class="n">EnvironmentFile</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">flanneld</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">flanneld</span> <span class="p">-</span><span class="n">-ip-masq</span> <span class="p">\</span><span class="nv">$FLANNEL_OPTIONS</span>
<span class="n">ExecStartPost</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">mk-docker-opts</span><span class="p">.</span><span class="n">sh</span> <span class="n">-k</span> <span class="n">DOCKER_NETWORK_OPTIONS</span> <span class="n">-d</span> <span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">subnet</span><span class="p">.</span><span class="n">env</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
   
<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
   
<span class="nb">mv </span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">bak</span>
   
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Docker</span> <span class="n">Application</span> <span class="n">Container</span> <span class="n">Engine</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">docs</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="n">com</span>
<span class="n">After</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span> <span class="n">firewalld</span><span class="p">.</span><span class="n">service</span>
<span class="n">Wants</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span>
   
<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">notify</span>
<span class="n">EnvironmentFile</span><span class="p">=/</span><span class="n">run</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">subnet</span><span class="p">.</span><span class="n">env</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">dockerd</span> <span class="p">\</span><span class="nv">$DOCKER_NETWORK_OPTIONS</span>
<span class="n">ExecReload</span><span class="p">=/</span><span class="n">bin</span><span class="p">/</span><span class="nb">kill </span><span class="n">-s</span> <span class="n">HUP</span> <span class="p">\</span><span class="nv">$MAINPID</span>
<span class="n">LimitNOFILE</span><span class="p">=</span><span class="n">infinity</span>
<span class="n">LimitNPROC</span><span class="p">=</span><span class="n">infinity</span>
<span class="n">LimitCORE</span><span class="p">=</span><span class="n">infinity</span>
<span class="n">TimeoutStartSec</span><span class="p">=</span><span class="n">0</span>
<span class="n">Delegate</span><span class="p">=</span><span class="n">yes</span>
<span class="n">KillMode</span><span class="p">=</span><span class="k">process</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">StartLimitBurst</span><span class="p">=</span><span class="n">3</span>
<span class="n">StartLimitInterval</span><span class="p">=</span><span class="n">60s</span>
   
<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
   
<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">flanneld</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">flanneld</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c">#</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># sh -x flannel.sh https://172.16.207.128:2379,https://172.16.207.129:2379,https://172.16.207.130:2379</span>
<span class="p">+</span> <span class="n">ETCD_ENDPOINTS</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span><span class="err">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span><span class="err">:</span><span class="n">2379</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">mv </span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">bak</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="p">+</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">flanneld</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">flanneld</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">flanneld</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">+</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">flanneld</span>
<span class="p">+</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># systemctl status docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># systemctl status flannel</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>检测是否生效</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># node1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># ifconfig</span>
<span class="n">docker0</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4099</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
     <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">0</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">255</span>
        <span class="n">ether</span> <span class="n">02</span><span class="err">:</span><span class="n">42</span><span class="err">:</span><span class="n">fe</span><span class="err">:</span><span class="n">58</span><span class="err">:</span><span class="n">17</span><span class="err">:</span><span class="n">03</span>  <span class="n">txqueuelen</span> <span class="n">0</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">ens33</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">0</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">255</span>
        <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">20c</span><span class="err">:</span><span class="n">29ff</span><span class="err">:</span><span class="n">fe20</span><span class="err">:</span><span class="n">ee59</span>  <span class="n">prefixlen</span> <span class="n">64</span>  <span class="n">scopeid</span> <span class="n">0x20</span><span class="p">&lt;</span><span class="n">link</span><span class="p">&gt;</span>
        <span class="n">ether</span> <span class="n">00</span><span class="err">:</span><span class="n">0c</span><span class="err">:</span><span class="n">29</span><span class="err">:</span><span class="n">20</span><span class="err">:</span><span class="n">ee</span><span class="err">:</span><span class="n">59</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">636501</span>  <span class="n">bytes</span> <span class="n">196057213</span> <span class="p">(</span><span class="n">186</span><span class="p">.</span><span class="n">9</span> <span class="n">MiB</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">593239</span>  <span class="n">bytes</span> <span class="n">77977323</span> <span class="p">(</span><span class="n">74</span><span class="p">.</span><span class="n">3</span> <span class="n">MiB</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">0</span>
        <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">380d</span><span class="err">:</span><span class="n">d6ff</span><span class="err">:</span><span class="n">fe3a</span><span class="err">:</span><span class="n">2fc8</span>  <span class="n">prefixlen</span> <span class="n">64</span>  <span class="n">scopeid</span> <span class="n">0x20</span><span class="p">&lt;</span><span class="n">link</span><span class="p">&gt;</span>
        <span class="n">ether</span> <span class="n">3a</span><span class="err">:</span><span class="n">0d</span><span class="err">:</span><span class="n">d6</span><span class="err">:</span><span class="n">3a</span><span class="err">:</span><span class="n">2f</span><span class="err">:</span><span class="n">c8</span>  <span class="n">txqueuelen</span> <span class="n">0</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">4</span>  <span class="n">bytes</span> <span class="n">336</span> <span class="p">(</span><span class="n">336</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">4</span>  <span class="n">bytes</span> <span class="n">336</span> <span class="p">(</span><span class="n">336</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">5</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">lo</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">73</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">LOOPBACK</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">65536</span>
        <span class="n">inet</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">inet6</span> <span class="p">::</span><span class="n">1</span>  <span class="n">prefixlen</span> <span class="n">128</span>  <span class="n">scopeid</span> <span class="n">0x10</span><span class="p">&lt;</span><span class="n">host</span><span class="p">&gt;</span>
        <span class="n">loop</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Local</span> <span class="n">Loopback</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">4281</span>  <span class="n">bytes</span> <span class="n">252413</span> <span class="p">(</span><span class="n">246</span><span class="p">.</span><span class="n">4</span> <span class="n">KiB</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">4281</span>  <span class="n">bytes</span> <span class="n">252413</span> <span class="p">(</span><span class="n">246</span><span class="p">.</span><span class="n">4</span> <span class="n">KiB</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
<span class="c"># node2</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># ifconfig</span>
<span class="n">docker0</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4099</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">1</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">0</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">255</span>
        <span class="n">ether</span> <span class="n">02</span><span class="err">:</span><span class="n">42</span><span class="err">:</span><span class="n">96</span><span class="err">:</span><span class="n">b0</span><span class="err">:</span><span class="n">5d</span><span class="err">:</span><span class="n">87</span>  <span class="n">txqueuelen</span> <span class="n">0</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">ens33</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">0</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">255</span>
        <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">20c</span><span class="err">:</span><span class="n">29ff</span><span class="err">:</span><span class="n">fe22</span><span class="err">:</span><span class="n">ab4f</span>  <span class="n">prefixlen</span> <span class="n">64</span>  <span class="n">scopeid</span> <span class="n">0x20</span><span class="p">&lt;</span><span class="n">link</span><span class="p">&gt;</span>
        <span class="n">ether</span> <span class="n">00</span><span class="err">:</span><span class="n">0c</span><span class="err">:</span><span class="n">29</span><span class="err">:</span><span class="n">22</span><span class="err">:</span><span class="n">ab</span><span class="err">:</span><span class="n">4f</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">425448</span>  <span class="n">bytes</span> <span class="n">172365242</span> <span class="p">(</span><span class="n">164</span><span class="p">.</span><span class="n">3</span> <span class="n">MiB</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">376747</span>  <span class="n">bytes</span> <span class="n">53642545</span> <span class="p">(</span><span class="n">51</span><span class="p">.</span><span class="n">1</span> <span class="n">MiB</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">0</span>
        <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">f484</span><span class="err">:</span><span class="n">69ff</span><span class="err">:</span><span class="n">fe3a</span><span class="err">:</span><span class="n">a49e</span>  <span class="n">prefixlen</span> <span class="n">64</span>  <span class="n">scopeid</span> <span class="n">0x20</span><span class="p">&lt;</span><span class="n">link</span><span class="p">&gt;</span>
        <span class="n">ether</span> <span class="n">f6</span><span class="err">:</span><span class="n">84</span><span class="err">:</span><span class="n">69</span><span class="err">:</span><span class="n">3a</span><span class="err">:</span><span class="n">a4</span><span class="err">:</span><span class="n">9e</span>  <span class="n">txqueuelen</span> <span class="n">0</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">0</span>  <span class="n">bytes</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">5</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
   
<span class="n">lo</span><span class="err">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">73</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">LOOPBACK</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">65536</span>
        <span class="n">inet</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">inet6</span> <span class="p">::</span><span class="n">1</span>  <span class="n">prefixlen</span> <span class="n">128</span>  <span class="n">scopeid</span> <span class="n">0x10</span><span class="p">&lt;</span><span class="n">host</span><span class="p">&gt;</span>
        <span class="n">loop</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Local</span> <span class="n">Loopback</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">3900</span>  <span class="n">bytes</span> <span class="n">212224</span> <span class="p">(</span><span class="n">207</span><span class="p">.</span><span class="n">2</span> <span class="n">KiB</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span>  <span class="n">overruns</span> <span class="n">0</span>  <span class="n">frame</span> <span class="n">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="n">3900</span>  <span class="n">bytes</span> <span class="n">212224</span> <span class="p">(</span><span class="n">207</span><span class="p">.</span><span class="n">2</span> <span class="n">KiB</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="n">0</span>  <span class="n">dropped</span> <span class="n">0</span> <span class="n">overruns</span> <span class="n">0</span>  <span class="n">carrier</span> <span class="n">0</span>  <span class="n">collisions</span> <span class="n">0</span>
</code></pre></td></tr></table>
</div>
</div><p>确保 docker0 和 flannel.1 在同一个网段。测试不同节点互通：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">flannel</span><span class="p">]</span><span class="c"># ping 172.17.66.1 -c 2</span>
<span class="n">PING</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span> <span class="p">(</span><span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span><span class="err">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">64</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">689</span> <span class="n">ms</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span><span class="err">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">2</span> <span class="n">ttl</span><span class="p">=</span><span class="n">64</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">750</span> <span class="n">ms</span>
   
<span class="p">---</span> <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">66</span><span class="p">.</span><span class="n">1</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="p">---</span>
<span class="n">2</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="n">2</span> <span class="n">received</span><span class="p">,</span> <span class="n">0</span><span class="p">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="n">1000ms</span>
<span class="n">rtt</span> <span class="n">min</span><span class="p">/</span><span class="n">avg</span><span class="p">/</span><span class="n">max</span><span class="p">/</span><span class="n">mdev</span> <span class="p">=</span> <span class="n">0</span><span class="p">.</span><span class="n">689</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">719</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">750</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">040</span> <span class="n">ms</span>
</code></pre></td></tr></table>
</div>
</div><p>如果能通说明Flannel部署成功。如果不通检查下日志：journalctl -u flannel -f</p>
</li>
</ol>
<h2 id="五在-master-节点部署组件">五、在 master 节点部署组件</h2>
<p><strong>1. 生成证书</strong></p>
<p>使用脚本完成证书的创建。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir /opt/kubernetes/{bin,cfg,ssl,logs} -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd /opt/kubernetes/ssl/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># vim gen_cert.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># cat gen_cert.sh</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
  <span class="s2">&#34;signing&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">&#34;default&#34;</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">&#34;expiry&#34;</span><span class="err">:</span> <span class="s2">&#34;87600h&#34;</span>
    <span class="p">},</span>
    <span class="s2">&#34;profiles&#34;</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">&#34;kubernetes&#34;</span><span class="err">:</span> <span class="p">{</span>
         <span class="s2">&#34;expiry&#34;</span><span class="err">:</span> <span class="s2">&#34;87600h&#34;</span><span class="p">,</span>
         <span class="s2">&#34;usages&#34;</span><span class="err">:</span> <span class="p">[</span>
            <span class="s2">&#34;signing&#34;</span><span class="p">,</span>
            <span class="s2">&#34;key encipherment&#34;</span><span class="p">,</span>
            <span class="s2">&#34;server auth&#34;</span><span class="p">,</span>
            <span class="s2">&#34;client auth&#34;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&gt;</span> <span class="n">ca-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
    <span class="s2">&#34;CN&#34;</span><span class="err">:</span> <span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span>
    <span class="s2">&#34;key&#34;</span><span class="err">:</span> <span class="p">{</span>
        <span class="s2">&#34;algo&#34;</span><span class="err">:</span> <span class="s2">&#34;rsa&#34;</span><span class="p">,</span>
        <span class="s2">&#34;size&#34;</span><span class="err">:</span> <span class="n">2048</span>
    <span class="p">},</span>
    <span class="s2">&#34;names&#34;</span><span class="err">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&#34;C&#34;</span><span class="err">:</span> <span class="s2">&#34;CN&#34;</span><span class="p">,</span>
            <span class="s2">&#34;L&#34;</span><span class="err">:</span> <span class="s2">&#34;Beijing&#34;</span><span class="p">,</span>
            <span class="s2">&#34;ST&#34;</span><span class="err">:</span> <span class="s2">&#34;Beijing&#34;</span><span class="p">,</span>
            <span class="s2">&#34;O&#34;</span><span class="err">:</span> <span class="s2">&#34;k8s&#34;</span><span class="p">,</span>
            <span class="s2">&#34;OU&#34;</span><span class="err">:</span> <span class="s2">&#34;System&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
<span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-initca</span> <span class="n">ca-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">ca</span> <span class="p">-</span>
<span class="c">#-----------------------</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="n">server-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
    <span class="s2">&#34;CN&#34;</span><span class="err">:</span> <span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span>
    <span class="s2">&#34;hosts&#34;</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">&#34;10.0.0.1&#34;</span><span class="p">,</span>
      <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
      <span class="s2">&#34;172.16.207.128&#34;</span><span class="p">,</span>
      <span class="s2">&#34;172.16.207.129&#34;</span><span class="p">,</span>
      <span class="s2">&#34;172.16.207.130&#34;</span><span class="p">,</span>
      <span class="s2">&#34;172.16.207.131&#34;</span><span class="p">,</span>
      <span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span>
      <span class="s2">&#34;kubernetes.default&#34;</span><span class="p">,</span>
      <span class="s2">&#34;kubernetes.default.svc&#34;</span><span class="p">,</span>
      <span class="s2">&#34;kubernetes.default.svc.cluster&#34;</span><span class="p">,</span>
      <span class="s2">&#34;kubernetes.default.svc.cluster.local&#34;</span>
    <span class="p">],</span>
    <span class="s2">&#34;key&#34;</span><span class="err">:</span> <span class="p">{</span>
        <span class="s2">&#34;algo&#34;</span><span class="err">:</span> <span class="s2">&#34;rsa&#34;</span><span class="p">,</span>
        <span class="s2">&#34;size&#34;</span><span class="err">:</span> <span class="n">2048</span>
    <span class="p">},</span>
    <span class="s2">&#34;names&#34;</span><span class="err">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&#34;C&#34;</span><span class="err">:</span> <span class="s2">&#34;CN&#34;</span><span class="p">,</span>
            <span class="s2">&#34;L&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
            <span class="s2">&#34;ST&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
            <span class="s2">&#34;O&#34;</span><span class="err">:</span> <span class="s2">&#34;k8s&#34;</span><span class="p">,</span>
            <span class="s2">&#34;OU&#34;</span><span class="err">:</span> <span class="s2">&#34;System&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
<span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">server-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">server</span>
<span class="c">#-----------------------</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="n">admin-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
  <span class="s2">&#34;CN&#34;</span><span class="err">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>
  <span class="s2">&#34;hosts&#34;</span><span class="err">:</span> <span class="p">[],</span>
  <span class="s2">&#34;key&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">&#34;algo&#34;</span><span class="err">:</span> <span class="s2">&#34;rsa&#34;</span><span class="p">,</span>
    <span class="s2">&#34;size&#34;</span><span class="err">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&#34;names&#34;</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&#34;C&#34;</span><span class="err">:</span> <span class="s2">&#34;CN&#34;</span><span class="p">,</span>
      <span class="s2">&#34;L&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
      <span class="s2">&#34;ST&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
      <span class="s2">&#34;O&#34;</span><span class="err">:</span> <span class="s2">&#34;system:masters&#34;</span><span class="p">,</span>
      <span class="s2">&#34;OU&#34;</span><span class="err">:</span> <span class="s2">&#34;System&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">admin-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">admin</span>
<span class="c">#-----------------------</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-proxy-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">{</span>
  <span class="s2">&#34;CN&#34;</span><span class="err">:</span> <span class="s2">&#34;system:kube-proxy&#34;</span><span class="p">,</span>
  <span class="s2">&#34;hosts&#34;</span><span class="err">:</span> <span class="p">[],</span>
  <span class="s2">&#34;key&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">&#34;algo&#34;</span><span class="err">:</span> <span class="s2">&#34;rsa&#34;</span><span class="p">,</span>
    <span class="s2">&#34;size&#34;</span><span class="err">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&#34;names&#34;</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&#34;C&#34;</span><span class="err">:</span> <span class="s2">&#34;CN&#34;</span><span class="p">,</span>
      <span class="s2">&#34;L&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
      <span class="s2">&#34;ST&#34;</span><span class="err">:</span> <span class="s2">&#34;BeiJing&#34;</span><span class="p">,</span>
      <span class="s2">&#34;O&#34;</span><span class="err">:</span> <span class="s2">&#34;k8s&#34;</span><span class="p">,</span>
      <span class="s2">&#34;OU&#34;</span><span class="err">:</span> <span class="s2">&#34;System&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">kube-proxy-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">kube-proxy</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># sh gen_cert.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">ssl</span><span class="p">]</span><span class="c"># ls *.pem</span>
<span class="n">admin-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">admin</span><span class="p">.</span><span class="n">pem</span>  <span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">ca</span><span class="p">.</span><span class="n">pem</span>  <span class="n">kube-proxy-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">pem</span>  <span class="n">server-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">server</span><span class="p">.</span><span class="n">pem</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2. 部署 apiserver 组件</strong></p>
<p>1）解压压缩包，复制用到的可执行文件到 <code>/opt/kubenetes/bin/</code>目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># tar zxvf kubernetes-server-linux-amd64.tar.gz</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd kubernetes/server/bin</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># cp kube-apiserver kube-controller-manager kube-scheduler kubectl /opt/kubernetes/bin/</span>
</code></pre></td></tr></table>
</div>
</div><p>2）创建 token 文件，后面会用到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;</span>
<span class="n">dbefc3df7404a01ba94eabbac49b3654</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># vim /opt/kubernetes/cfg/token.csv</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># cat /opt/kubernetes/cfg/token.csv</span>
<span class="n">dbefc3df7404a01ba94eabbac49b3654</span><span class="p">,</span><span class="n">kubelet-bootstrap</span><span class="p">,</span><span class="n">10001</span><span class="p">,</span><span class="s2">&#34;system:node-bootstrapper&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>第一列：随机字符串，自己可生成 第二列：用户名 第三列：UID 第四列：用户组</p>
<p>3）创建 apiserver 配置文件</p>
<p>使用脚本完成 apiserver 相关配置文件的创建和服务的启动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># mkdir /root/k8s/master -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># cd /root/k8s/master/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># vim apiserver.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># cat apiserver.sh</span>
<span class="c">#!/bin/bash</span>

<span class="n">MASTER_ADDRESS</span><span class="p">=</span><span class="nv">$1</span>
<span class="n">ETCD_SERVERS</span><span class="p">=</span><span class="nv">$2</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-apiserver</span>

<span class="n">KUBE_APISERVER_OPTS</span><span class="p">=</span><span class="s2">&#34;--logtostderr=true \\
</span><span class="s2">--v=4 \\
</span><span class="s2">--log-dir=/opt/kubernetes/logs \\
</span><span class="s2">--etcd-servers=${ETCD_SERVERS} \\
</span><span class="s2">--bind-address=${MASTER_ADDRESS} \\
</span><span class="s2">--secure-port=6443 \\
</span><span class="s2">--advertise-address=${MASTER_ADDRESS} \\
</span><span class="s2">--allow-privileged=true \\
</span><span class="s2">--service-cluster-ip-range=10.0.0.0/24 \\
</span><span class="s2">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
</span><span class="s2">--authorization-mode=RBAC,Node \\
</span><span class="s2">--kubelet-https=true \\
</span><span class="s2">--enable-bootstrap-token-auth \\
</span><span class="s2">--token-auth-file=/opt/kubernetes/cfg/token.csv \\
</span><span class="s2">--service-node-port-range=30000-50000 \\
</span><span class="s2">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\
</span><span class="s2">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\
</span><span class="s2">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span><span class="s2">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span><span class="s2">--etcd-cafile=/opt/etcd/ssl/ca.pem \\
</span><span class="s2">--etcd-certfile=/opt/etcd/ssl/server.pem \\
</span><span class="s2">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
</span><span class="s2">--audit-log-maxage=30 \\
</span><span class="s2">--audit-log-maxbackup=3 \\
</span><span class="s2">--audit-log-maxsize=100 \\
</span><span class="s2">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&#34;</span>
<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">API</span> <span class="n">Server</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-apiserver</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-apiserver</span> <span class="p">\</span><span class="nv">$KUBE_APISERVER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>

<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">kube-apiserver</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">kube-apiserver</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># sh -x apiserver.sh 172.16.207.128 https://172.16.207.128:2379,https://172.16.207.129:2379,https://172.16.207.130:2379</span>
<span class="p">+</span> <span class="n">MASTER_ADDRESS</span><span class="p">=</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span>
<span class="p">+</span> <span class="n">ETCD_SERVERS</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span><span class="err">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">130</span><span class="err">:</span><span class="n">2379</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="p">+</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">kube-apiserver</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">+</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">kube-apiserver</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl status kube-apiserver</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># netstat -lntp | grep kube</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">6443</span>     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">8080</span>          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3. 部署 scheduler 组件</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># vim scheduler.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># cat scheduler.sh</span>
<span class="c">#!/bin/bash</span>

<span class="n">MASTER_ADDRESS</span><span class="p">=</span><span class="nv">$1</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-scheduler</span>
<span class="n">KUBE_SCHEDULER_OPTS</span><span class="p">=</span><span class="s2">&#34;--logtostderr=true \\
</span><span class="s2">--v=4 \\
</span><span class="s2">--log-dir=/opt/kubernetes/logs \\
</span><span class="s2">--master=${MASTER_ADDRESS}:8080 \\
</span><span class="s2">--leader-elect&#34;</span>
<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Scheduler</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-scheduler</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-scheduler</span> <span class="p">\</span><span class="nv">$KUBE_SCHEDULER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># sh -x scheduler.sh 127.0.0.1</span>
<span class="p">+</span> <span class="n">MASTER_ADDRESS</span><span class="p">=</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span>
<span class="c"># 启动 scheduler</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl enable kube-scheduler</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl start kube-scheduler</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># netstat -lnpt |grep kube</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">6443</span>     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">8080</span>          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="err">:</span><span class="n">10251</span>                <span class="p">::</span><span class="err">:</span><span class="p">*</span>                    <span class="n">LISTEN</span>      <span class="n">16597</span><span class="p">/</span><span class="n">kube-schedule</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="err">:</span><span class="n">10259</span>                <span class="p">::</span><span class="err">:</span><span class="p">*</span>                    <span class="n">LISTEN</span>      <span class="n">16597</span><span class="p">/</span><span class="n">kube-schedule</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>4. 部署 controller-manager 组件</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># vim controller-manager.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># cat controller-manager.sh</span>
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-controller-manager</span>
<span class="n">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="p">=</span><span class="s2">&#34;--logtostderr=true \\
</span><span class="s2">--v=4 \\
</span><span class="s2">--log-dir=/opt/kubernetes/logs \\
</span><span class="s2">--master=127.0.0.1:8080 \\
</span><span class="s2">--leader-elect=true \\
</span><span class="s2">--address=127.0.0.1 \\
</span><span class="s2">--service-cluster-ip-range=10.0.0.0/24 \\
</span><span class="s2">--cluster-name=kubernetes \\
</span><span class="s2">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
</span><span class="s2">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
</span><span class="s2">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
</span><span class="s2">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
</span><span class="s2">--experimental-cluster-signing-duration=87600h0m0s&#34;</span>
<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Controller</span> <span class="n">Manager</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-controller-manager</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-controller-manager</span> <span class="p">\</span><span class="nv">$KUBE_CONTROLLER_MANAGER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># sh -x controller-manager.sh</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl enable kube-controller-manager</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># systemctl start kube-controller-manager</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># netstat -lntp | grep kube</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">128</span><span class="err">:</span><span class="n">6443</span>     <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">10252</span>         <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16656</span><span class="p">/</span><span class="n">kube-controll</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="err">:</span><span class="n">8080</span>          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="err">:</span><span class="p">*</span>               <span class="n">LISTEN</span>      <span class="n">16536</span><span class="p">/</span><span class="n">kube-apiserve</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="err">:</span><span class="n">10251</span>                <span class="p">::</span><span class="err">:</span><span class="p">*</span>                    <span class="n">LISTEN</span>      <span class="n">16597</span><span class="p">/</span><span class="n">kube-schedule</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="err">:</span><span class="n">10257</span>                <span class="p">::</span><span class="err">:</span><span class="p">*</span>                    <span class="n">LISTEN</span>      <span class="n">16656</span><span class="p">/</span><span class="n">kube-controll</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="err">:</span><span class="n">10259</span>                <span class="p">::</span><span class="err">:</span><span class="p">*</span>                    <span class="n">LISTEN</span>      <span class="n">16597</span><span class="p">/</span><span class="n">kube-schedule</span>
</code></pre></td></tr></table>
</div>
</div><p>master 所有组件都已经部署成功，通过 kubectl 工具查看当前集群组件状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># cp /opt/kubernetes/bin/ckubectl /usr/local/bin/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">master</span><span class="p">]</span><span class="c"># kubectl get cs</span>
<span class="n">Warning</span><span class="err">:</span> <span class="n">v1</span> <span class="n">ComponentStatus</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="k">in</span> <span class="n">v1</span><span class="p">.</span><span class="n">19</span><span class="p">+</span>
<span class="n">NAME</span>                 <span class="n">STATUS</span>    <span class="n">MESSAGE</span>             <span class="n">ERROR</span>
<span class="n">controller-manager</span>   <span class="n">Healthy</span>   <span class="n">ok</span>
<span class="n">scheduler</span>            <span class="n">Healthy</span>   <span class="n">ok</span>
<span class="n">etcd</span><span class="p">-</span><span class="n">2</span>               <span class="n">Healthy</span>   <span class="p">{</span><span class="s2">&#34;health&#34;</span><span class="err">:</span><span class="s2">&#34;true&#34;</span><span class="p">}</span>
<span class="n">etcd</span><span class="p">-</span><span class="n">0</span>               <span class="n">Healthy</span>   <span class="p">{</span><span class="s2">&#34;health&#34;</span><span class="err">:</span><span class="s2">&#34;true&#34;</span><span class="p">}</span>
<span class="n">etcd</span><span class="p">-</span><span class="n">1</span>               <span class="n">Healthy</span>   <span class="p">{</span><span class="s2">&#34;health&#34;</span><span class="err">:</span><span class="s2">&#34;true&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="六在-node-节点部署组件">六、在 Node 节点部署组件</h2>
<p>Master apiserver 启用 TLS 认证后，Node 节点 kubelet 组件想要加入集群，必须使用 CA 签发的有效证书才能与 apiserver 通信，当 Node 节点很多时，签署证书是一件很繁琐的事情，因此有了 TLS Bootstrapping 机制，kubelet  会以一个低权限用户自动向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署。</p>
<p><strong>1. 将 kubelet-bootstrap 用户绑定到系统集群角色</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl create clusterrolebinding kubelet-bootstrap  --clusterrole=system:node-bootstrapper  --user=kubelet-bootstrap</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kubelet-bootstrap</span> <span class="n">created</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># echo $?</span>
<span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c">#</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2. 创建 kubeconfig 文件</strong></p>
<p>在生成 kubernetes 证书的目录下执行以下命令生成 kubeconfig 文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir /root/k8s/node -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cd /root/k8s/node/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># cat /opt/kubernetes/cfg/token.csv</span>
<span class="n">dbefc3df7404a01ba94eabbac49b3654</span><span class="p">,</span><span class="n">kubelet-bootstrap</span><span class="p">,</span><span class="n">10001</span><span class="p">,</span><span class="s2">&#34;system:node-bootstrapper&#34;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># cat /opt/kubernetes/cfg/token.csv | awk -F &#39;,&#39; &#39;{print $1}&#39;</span>
<span class="n">dbefc3df7404a01ba94eabbac49b3654</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># vim kubeconfig.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># cat kubeconfig.sh</span>
<span class="c"># 创建 TLS Bootstrapping Token</span>
<span class="n">BOOTSTRAP_TOKEN</span><span class="p">=$(</span><span class="nb">cat </span><span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">token</span><span class="p">.</span><span class="n">csv</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span> <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="p">)</span>

<span class="c">#----------------------</span>

<span class="n">APISERVER</span><span class="p">=</span><span class="nv">$1</span>
<span class="n">SSL_DIR</span><span class="p">=</span><span class="nv">$2</span>

<span class="c"># 创建kubelet bootstrapping kubeconfig</span>
<span class="n">export</span> <span class="n">KUBE_APISERVER</span><span class="p">=</span><span class="s2">&#34;https://$APISERVER:6443&#34;</span>

<span class="c"># 设置集群参数</span>
<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="nv">$SSL_DIR</span><span class="p">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-server</span><span class="p">=${</span><span class="n">KUBE_APISERVER</span><span class="p">}</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c"># 设置客户端认证参数</span>
<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">kubelet-bootstrap</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-token</span><span class="p">=${</span><span class="n">BOOTSTRAP_TOKEN</span><span class="p">}</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c"># 设置上下文参数</span>
<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="k">default</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kubelet-bootstrap</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c"># 设置默认上下文</span>
<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c">#----------------------</span>

<span class="c"># 创建kube-proxy kubeconfig文件</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="nv">$SSL_DIR</span><span class="p">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-server</span><span class="p">=${</span><span class="n">KUBE_APISERVER</span><span class="p">}</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">kube-proxy</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-client-certificate</span><span class="p">=</span><span class="nv">$SSL_DIR</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-client-key</span><span class="p">=</span><span class="nv">$SSL_DIR</span><span class="p">/</span><span class="n">kube-proxy-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="k">default</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kube-proxy</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># sh -x kubeconfig.sh 172.16.207.128 /opt/kubernetes/ssl</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># ls *config</span>
<span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c"># 将生成的 2 个 kubeconfig 文件拷贝到 node 节点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># scp *config node1:/opt/kubernetes/cfg/</span>
<span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>                                                                                                                          <span class="n">100</span><span class="p">%</span> <span class="n">2168</span>     <span class="n">1</span><span class="p">.</span><span class="n">7MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>                                                                                                                         <span class="n">100</span><span class="p">%</span> <span class="n">6274</span>     <span class="n">5</span><span class="p">.</span><span class="n">8MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c"># scp *config node2:/opt/kubernetes/cfg/</span>
<span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>                                                                                                                          <span class="n">100</span><span class="p">%</span> <span class="n">2168</span>     <span class="n">2</span><span class="p">.</span><span class="n">4MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>                                                                                                                         <span class="n">100</span><span class="p">%</span> <span class="n">6274</span>     <span class="n">6</span><span class="p">.</span><span class="n">6MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">node</span><span class="p">]</span><span class="c">#</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>3. 部署 kubelet 组件</strong></p>
<p>将前面解压出来的 kubelet 和 kube-proxy 拷贝到 node 节点 /opt/kubernetes/bin 目录下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># scp kubelet kube-proxy node1:/opt/kubernetes/bin/</span>
<span class="n">kubelet</span>                                                                                                                                       <span class="n">100</span><span class="p">%</span>  <span class="n">105MB</span>  <span class="n">51</span><span class="p">.</span><span class="n">9MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">02</span>
<span class="n">kube-proxy</span>                                                                                                                                    <span class="n">100</span><span class="p">%</span>   <span class="n">37MB</span>  <span class="n">49</span><span class="p">.</span><span class="n">8MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># scp kubelet kube-proxy node2:/opt/kubernetes/bin/</span>
<span class="n">kubelet</span>                                                                                                                                       <span class="n">100</span><span class="p">%</span>  <span class="n">105MB</span>  <span class="n">56</span><span class="p">.</span><span class="n">0MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">01</span>
<span class="n">kube-proxy</span>                                                                                                                                    <span class="n">100</span><span class="p">%</span>   <span class="n">37MB</span>  <span class="n">54</span><span class="p">.</span><span class="n">6MB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="err">:</span><span class="n">00</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c">#</span>
</code></pre></td></tr></table>
</div>
</div><p>创建 kubelet 配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># mkdir -p /root/k8s/node</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="p">~]</span><span class="c"># cd /root/k8s/node/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># vim kubelet.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># cat kubelet.sh</span>
<span class="c">#!/bin/bash</span>

<span class="n">NODE_ADDRESS</span><span class="p">=</span><span class="nv">$1</span>
<span class="n">DNS_SERVER_IP</span><span class="p">=${</span><span class="n">2</span><span class="err">:</span><span class="p">-</span><span class="s2">&#34;10.0.0.2&#34;</span><span class="p">}</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kubelet</span>

<span class="n">KUBELET_OPTS</span><span class="p">=</span><span class="s2">&#34;--logtostderr=true \\
</span><span class="s2">--v=4 \\
</span><span class="s2">--log-dir=/opt/kubernetes/logs \\
</span><span class="s2">--hostname-override=${NODE_ADDRESS} \\
</span><span class="s2">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
</span><span class="s2">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
</span><span class="s2">--config=/opt/kubernetes/cfg/kubelet.config \\
</span><span class="s2">--cert-dir=/opt/kubernetes/ssl \\
</span><span class="s2">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&#34;</span>

<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">config</span>

<span class="n">kind</span><span class="err">:</span> <span class="n">KubeletConfiguration</span>
<span class="n">apiVersion</span><span class="err">:</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta1</span>
<span class="n">address</span><span class="err">:</span> <span class="p">${</span><span class="n">NODE_ADDRESS</span><span class="p">}</span>
<span class="n">port</span><span class="err">:</span> <span class="n">10250</span>
<span class="n">readOnlyPort</span><span class="err">:</span> <span class="n">10255</span>
<span class="n">cgroupDriver</span><span class="err">:</span> <span class="n">cgroupfs</span>
<span class="n">clusterDNS</span><span class="err">:</span>
<span class="p">-</span> <span class="p">${</span><span class="n">DNS_SERVER_IP</span><span class="p">}</span>
<span class="n">clusterDomain</span><span class="err">:</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span>
<span class="n">failSwapOn</span><span class="err">:</span> <span class="n">false</span>
<span class="n">authentication</span><span class="err">:</span>
  <span class="n">anonymous</span><span class="err">:</span>
    <span class="n">enabled</span><span class="err">:</span> <span class="n">true</span>
<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Kubelet</span>
<span class="n">After</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>
<span class="n">Requires</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kubelet</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kubelet</span> <span class="p">\</span><span class="nv">$KUBELET_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">KillMode</span><span class="p">=</span><span class="k">process</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># sh -x kubelet.sh 172.16.207.129</span>
<span class="p">+</span> <span class="n">NODE_ADDRESS</span><span class="p">=</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">207</span><span class="p">.</span><span class="n">129</span>
<span class="p">+</span> <span class="n">DNS_SERVER_IP</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>
<span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">+</span> <span class="nb">cat
</span><span class="nb"></span><span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># ll /opt/kubernetes/cfg/</span>
<span class="n">总用量</span> <span class="n">24</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">2168</span> <span class="n">10月</span> <span class="n">27</span> <span class="n">14</span><span class="err">:</span><span class="n">24</span> <span class="n">bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="n">236</span> <span class="n">10月</span> <span class="n">27</span> <span class="n">11</span><span class="err">:</span><span class="n">52</span> <span class="n">flanneld</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="n">378</span> <span class="n">10月</span> <span class="n">27</span> <span class="n">14</span><span class="err">:</span><span class="n">37</span> <span class="n">kubelet</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="n">267</span> <span class="n">10月</span> <span class="n">27</span> <span class="n">14</span><span class="err">:</span><span class="n">37</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">config</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">6274</span> <span class="n">10月</span> <span class="n">27</span> <span class="n">14</span><span class="err">:</span><span class="n">24</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="c"># 启动</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl enable kubelet</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl restart kubelet</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># ps -ef | grep kubelet</span>

<span class="c"># 复制脚本文件到另一个 node 节点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># scp -r /root/k8s node2:~</span>
</code></pre></td></tr></table>
</div>
</div><p>在 node2 节点执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="p">~]</span><span class="c"># cd k8s/node/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">node</span><span class="p">]</span><span class="c"># sh -x kubelet.sh 172.16.207.130</span>
<span class="c"># 启动</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl enable kubelet</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node2</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl start kubelet</span>
</code></pre></td></tr></table>
</div>
</div><p>在 Master 审批 Node 加入集群：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># kubectl get csr</span>
<span class="n">NAME</span>                                                   <span class="n">AGE</span>     <span class="n">SIGNERNAME</span>                                    <span class="n">REQUESTOR</span>           <span class="n">CONDITION</span>
<span class="n">node-csr</span><span class="p">-</span><span class="n">3ZdP9nsg0zrO5CAjYSn12J0s4FYeFVJFVQtxSM-keUM</span>   <span class="n">8m29s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Pending</span>
<span class="n">node-csr</span><span class="p">-</span><span class="n">5AkYXWfhxcBluIgDbHNy3xov6KQGlzZ-mjmGJyN5iG0</span>   <span class="n">2m28s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Pending</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># kubectl certificate approve node-csr-3ZdP9nsg0zrO5CAjYSn12J0s4FYeFVJFVQtxSM-keUM</span>
<span class="n">certificatesigningrequest</span><span class="p">.</span><span class="n">certificates</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">node-csr</span><span class="p">-</span><span class="n">3ZdP9nsg0zrO5CAjYSn12J0s4FYeFVJFVQtxSM-keUM</span> <span class="n">approved</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="n">bin</span><span class="p">]</span><span class="c"># kubectl certificate approve node-csr-5AkYXWfhxcBluIgDbHNy3xov6KQGlzZ-mjmGJyN5iG0</span>
<span class="n">certificatesigningrequest</span><span class="p">.</span><span class="n">certificates</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">node-csr</span><span class="p">-</span><span class="n">5AkYXWfhxcBluIgDbHNy3xov6KQGlzZ-mjmGJyN5iG0</span> <span class="n">approved</span>

<span class="c"># 等待一会儿，查看node</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>     <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">53m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">3</span>
<span class="n">node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">71m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">3</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>4. 部署 kube-proxy 组件</strong></p>
<p>创建 kube-proxy 配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># vim proxy.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># cat proxy.sh</span>
<span class="c">#!/bin/bash</span>

<span class="n">NODE_ADDRESS</span><span class="p">=</span><span class="nv">$1</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-proxy</span>

<span class="n">KUBE_PROXY_OPTS</span><span class="p">=</span><span class="s2">&#34;--logtostderr=true \\
</span><span class="s2">--v=4 \\
</span><span class="s2">--hostname-override=${NODE_ADDRESS} \\
</span><span class="s2">--cluster-cidr=10.0.0.0/24 \\
</span><span class="s2">--proxy-mode=ipvs \\
</span><span class="s2">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig&#34;</span>

<span class="n">EOF</span>

<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Proxy</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">kube-proxy</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-proxy</span> <span class="p">\</span><span class="nv">$KUBE_PROXY_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># sh proxy.sh 172.16.207.129</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl enable kube-proxy</span>
<span class="n">Created</span> <span class="n">symlink</span> <span class="n">from</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span> <span class="n">to</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># systemctl start kube-proxy</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@node1</span> <span class="n">node</span><span class="p">]</span><span class="c"># ps -ef | grep kube-proxy</span>
</code></pre></td></tr></table>
</div>
</div><p>node2 部署方式一样。</p>
<h2 id="七运行一个测试示例">七、运行一个测试示例</h2>
<p>创建一个Nginx Web，测试集群是否正常工作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl create deployment nginx --image=nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx</span> <span class="n">created</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6799fc88d8</span><span class="p">-</span><span class="n">9xd2l</span>   <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">ContainerCreating</span>   <span class="n">0</span>          <span class="n">8s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6799fc88d8</span><span class="p">-</span><span class="n">9xd2l</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">108s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get deployments</span>
<span class="n">NAME</span>    <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">1</span>            <span class="n">1</span>           <span class="n">119s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --port=80 --type=NodePort</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx</span> <span class="n">exposed</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pod,svc</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod</span><span class="p">/</span><span class="n">nginx</span><span class="p">-</span><span class="n">6799fc88d8</span><span class="p">-</span><span class="n">9xd2l</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m1s</span>

<span class="n">NAME</span>                 <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>
<span class="n">service</span><span class="p">/</span><span class="n">kubernetes</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>     <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>        <span class="n">18h</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx</span>        <span class="n">NodePort</span>    <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">203</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="err">:</span><span class="n">36567</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">7s</span>
</code></pre></td></tr></table>
</div>
</div><p>浏览器中访问 ip:36567 打开页面，如果看到的是我们熟悉的 Nginx 页面，说明集群正常工作了。（ip 可以是任一 node 的 ip）。</p>
<hr>
<p>以上就是二进制方式部署 K8S 集群的详细过程，部署过程中遇到的2个问题：</p>
<ol>
<li>
<p>flannel 启动失败</p>
<p>最新版本etcd和flannel兼容问题导致</p>
</li>
<li>
<p>kubelet 自动申请证书，手动 approve 后，证书一直处于Approved 状态，没有 Issued</p>
<p>证书签发是由 kube-controller-manager 完成，检查发现是 kube-controller-manager 配置文件参数 <code>--master</code>参数值不正确，应该为<code>--master=127.0.0.1:8080</code>，不能写操作系统通信网卡的 ip。</p>
</li>
</ol>
<p>参考博客：<a href="https://www.cnblogs.com/supery007/p/12799830.html">链接</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">jiaqiang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-10-26
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          <a href="/tags/etcd/">etcd</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/deploy-k8s-cluster-kubeadm-method/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">K8S 集群部署（kubeadm）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/deploy-etcd-cluster/">
            <span class="next-text nav-default">CentOS7 搭建 Etcd 集群</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:tangcugandoufu@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/gandoufu" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://gandoufu.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>jiaqiang</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>








</body>
</html>
